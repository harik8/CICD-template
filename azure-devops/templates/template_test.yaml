---
parameters:
  - name: str
    type: string
    default: false
  - name: tag
    type: string
    default: latest
  - name: repo
    type: string

stages:
- stage:
  variables:
  - group: test
  - name: major
    value: $[variables.major_version]
  - name: minor
    value: $[variables.minor_version]
  - name: patch
    value: $[variables.patch_version]
  - name: tag
    ${{ if eq(variables['Build.SourceBranchName'], 'main') }}:
      value: $(major).$(minor).$(patch)
    ${{ else }}:
      value: $(major).$(minor).$(patch)-${{ parameters.str }}
  pool: Kubernetes
  jobs:
  - job: BUILD_AND_PACKAGE-CI
    steps:
      - script: echo ${{ parameters.str }}
      - script: env
      - script: az
  # - job: BUILD
  #   displayName: BUILD IMAGE
      - task: Docker@2
        displayName: Build an image
        inputs:
          repository: harik8/test
          containerRegistry: DockerHub
          command: buildAndPush
          dockerfile: "**/Dockerfile"
          tags: |
            $(tag)
  # - job: PACKAGE
  #   displayName: HELM PACKAGE
      - task: HelmDeploy@0
        displayName: Package Helm
        inputs:
          connectionType: none
          comamnd: package
          kubernetesServiceEndpoint: WSL-Minikube
          chartName: ${{ parameters.repo }}
          chartPath: ./helm
          valueFile: ./helm/values.yaml
          destination: '$(Build.ArtifactStagingDirectory)'
      - script: ls -lah  $(Build.ArtifactStagingDirectory)
    
